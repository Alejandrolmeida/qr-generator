name: Deploy â€” Lanyards AI Generator

# â”€â”€â”€ Flujo de secretos â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#
#  GitHub Secrets (cifrados, solo para CI/CD):
#    AZURE_CLIENT_ID         â†’ App Registration OIDC (identidad del pipeline)
#    AZURE_TENANT_ID         â†’ Tenant de la suscripciÃ³n
#    AZURE_SUBSCRIPTION_ID   â†’ ID de la suscripciÃ³n
#    AZURE_OPENAI_API_KEY    â†’ Se sincroniza a AKV en cada deploy
#    CHAINLIT_AUTH_SECRET    â†’ Se sincroniza a AKV en cada deploy
#
#  GitHub Variables (no sensibles, Settings â†’ Variables):
#    AZURE_RG   â†’ Resource Group, p.ej. rg-lanyards-aigen
#    ACR_NAME   â†’ Nombre corto del ACR, p.ej. acrazurebrainschat
#
#  Azure Key Vault (authoritative runtime store):
#    lanyards-openai-api-key        â† sincronizado desde GitHub Secret
#    lanyards-chainlit-auth-secret  â† sincronizado desde GitHub Secret
#
#  Las Container Apps leen AKV directamente vÃ­a UAMI en runtime.
#  El pipeline NUNCA pasa secretos como parÃ¡metros Bicep.
#
# â”€â”€â”€ Prerequisito (una sola vez) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  Ejecutar scripts/setup-github-secrets.sh para:
#    1. Crear el App Registration con credenciales OIDC federadas
#    2. Asignar los roles necesarios (Contributor, AcrPush, AcrPull sobre UAMI)
#    3. Subir AZURE_CLIENT_ID, AZURE_TENANT_ID, AZURE_SUBSCRIPTION_ID a GitHub

on:
  workflow_run:
    workflows: ["Build & Push â€” Lanyards AI Generator"]
    types: [completed]
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Entorno de despliegue'
        required: false
        default: 'prod'
        type: choice
        options: [dev, prod]

permissions:
  id-token: write   # OIDC â€” necesario para az login
  contents: read

env:
  BACKEND_APP:    acrazurebrainschat.azurecr.io/lanyards/backend-app:latest
  FRONTEND_APP:   acrazurebrainschat.azurecr.io/lanyards/frontend-app:latest
  AZURE_LOCATION: westeurope
  PROJECT_NAME:   lanyards-aigen

jobs:
  deploy:
    name: Deploy ${{ github.event.inputs.environment || 'prod' }}
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event.workflow_run.conclusion == 'success'

    environment:
      name: ${{ github.event.inputs.environment || 'prod' }}

    steps:
      - uses: actions/checkout@v4

      # â”€â”€ 1. Login Azure (OIDC â€” sin credenciales en GitHub) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Login Azure (OIDC)
        uses: azure/login@v2
        with:
          client-id:       ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id:       ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # â”€â”€ 2. Crear Resource Group si no existe â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Crear Resource Group
        run: |
          ENV="${{ github.event.inputs.environment || 'prod' }}"
          az group create \
            --name     "${{ vars.AZURE_RG }}" \
            --location "${{ env.AZURE_LOCATION }}" \
            --tags     Environment="$ENV" Project=lanyards-ai-generator ManagedBy=Bicep-IaC \
            --output none
          echo "âœ… Resource Group: ${{ vars.AZURE_RG }}"

      # â”€â”€ 3. Crear AKV e inyectar secretos (idempotente) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      #   El AKV se crea tambiÃ©n vÃ­a Bicep (idempotente), pero necesitamos
      #   que los secretos existan ANTES de que Bicep despliegue las Container
      #   Apps (que los referencian vÃ­a keyVaultUrl).
      - name: Provisionar AKV y sincronizar secretos
        run: |
          ENV="${{ github.event.inputs.environment || 'prod' }}"
          KV_NAME="kv-${{ env.PROJECT_NAME }}-${ENV}"

          # Truncar a 24 chars (lÃ­mite de AKV)
          KV_NAME="${KV_NAME:0:24}"
          echo "kv_name=$KV_NAME" >> $GITHUB_ENV

          # Crear AKV si no existe (RBAC mode â€” sin access policies)
          EXISTING=$(az keyvault show --name "$KV_NAME" --query name -o tsv 2>/dev/null || echo "")
          if [ -z "$EXISTING" ]; then
            echo "ðŸ”‘ Creando Key Vault: $KV_NAME"
            az keyvault create \
              --name              "$KV_NAME" \
              --resource-group    "${{ vars.AZURE_RG }}" \
              --location          "${{ env.AZURE_LOCATION }}" \
              --enable-rbac-authorization true \
              --retention-days    7 \
              --output none
            echo "âœ… Key Vault creado"
          else
            echo "âœ… Key Vault ya existe: $KV_NAME"
          fi

          # Asignar Key Vault Secrets Officer al SP del pipeline (para poder escribir)
          SP_OID=$(az ad sp show \
            --id "$(az account show --query 'user.name' -o tsv)" \
            --query id -o tsv 2>/dev/null || \
            az account show --query 'user.assignedIdentityInfo' -o tsv 2>/dev/null || \
            az rest --method GET \
              --url "https://graph.microsoft.com/v1.0/servicePrincipals?\$filter=appId eq '${{ secrets.AZURE_CLIENT_ID }}'" \
              --query "value[0].id" -o tsv)

          KV_ID=$(az keyvault show --name "$KV_NAME" --query id -o tsv)
          az role assignment create \
            --assignee-object-id "$SP_OID" \
            --assignee-principal-type ServicePrincipal \
            --role "Key Vault Secrets Officer" \
            --scope "$KV_ID" \
            --output none 2>/dev/null || echo "â„¹ï¸ Rol ya asignado"

          # Sincronizar SOLO el secreto de Chainlit a AKV (OAI es keyless)
          echo "ðŸ“ Sincronizando secreto Chainlit a AKV..."
          az keyvault secret set \
            --vault-name "$KV_NAME" \
            --name "lanyards-chainlit-auth-secret" \
            --value "${{ secrets.CHAINLIT_AUTH_SECRET }}" \
            --output none

          echo "âœ… Secreto sincronizado en AKV: $KV_NAME"

      # â”€â”€ 4. Instalar Bicep CLI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Instalar Bicep
        run: az bicep install

      # â”€â”€ 5. What-if (solo informativo) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Validar Bicep (what-if)
        run: |
          ENV="${{ github.event.inputs.environment || 'prod' }}"
          az deployment group what-if \
            --resource-group "${{ vars.AZURE_RG }}" \
            --template-file  bicep/main.bicep \
            --parameters     bicep/parameters/${ENV}.bicepparam \
            --parameters \
              backendImage="${{ env.BACKEND_APP }}" \
              frontendImage="${{ env.FRONTEND_APP }}"

      # â”€â”€ 6. Desplegar infraestructura completa â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      #   main.bicep crea: UAMI, KV (idempotente), Storage, Container Apps.
      #   Los roles AcrPull y Storage Blob Data Contributor se asignan aquÃ­.
      - name: Deploy Bicep
        id: deploy
        run: |
          ENV="${{ github.event.inputs.environment || 'prod' }}"
          OUTPUT=$(az deployment group create \
            --resource-group "${{ vars.AZURE_RG }}" \
            --template-file  bicep/main.bicep \
            --parameters     bicep/parameters/${ENV}.bicepparam \
            --parameters \
              backendImage="${{ env.BACKEND_APP }}" \
              frontendImage="${{ env.FRONTEND_APP }}" \
            --query "properties.outputs" \
            --output json)

          FRONTEND_URL=$(echo "$OUTPUT" | jq -r '.frontendUrl.value')
          BACKEND_URL=$(echo "$OUTPUT"  | jq -r '.backendUrl.value')
          KV_NAME_OUT=$(echo "$OUTPUT"  | jq -r '.keyVaultName.value')
          UAMI_PID=$(echo "$OUTPUT"     | jq -r '.uamiPrincipalId.value')

          echo "frontend_url=$FRONTEND_URL" >> $GITHUB_OUTPUT
          echo "backend_url=$BACKEND_URL"   >> $GITHUB_OUTPUT
          echo "kv_name=$KV_NAME_OUT"       >> $GITHUB_OUTPUT
          echo "uami_principal_id=$UAMI_PID" >> $GITHUB_OUTPUT
          echo "âœ… Frontend: $FRONTEND_URL"
          echo "âœ… Backend:  $BACKEND_URL"
          echo "âœ… Key Vault: $KV_NAME_OUT"

      # â”€â”€ 7. Asignar AcrPull a la UAMI (idempotente) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      #   La UAMI necesita AcrPull para poder hacer pull de imÃ¡genes desde ACR.
      #   El ACR es un recurso externo (distinto RG), por eso se asigna aquÃ­.
      - name: Asignar AcrPull a UAMI
        run: |
          ACR_ID=$(az acr show \
            --name "${{ vars.ACR_NAME }}" \
            --query id -o tsv)

          az role assignment create \
            --assignee-object-id "${{ steps.deploy.outputs.uami_principal_id }}" \
            --assignee-principal-type ServicePrincipal \
            --role "AcrPull" \
            --scope "$ACR_ID" \
            --output none 2>/dev/null || echo "â„¹ï¸ AcrPull ya asignado"

          echo "âœ… AcrPull asignado a UAMI sobre ACR"

      # â”€â”€ 8. Asignar Cognitive Services OpenAI User a la UAMI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      #   Permite que backend y frontend accedan a Azure OpenAI SIN API key.
      #   OPENAI_RESOURCE_ID es un GitHub Variable (no sensible).
      - name: Asignar Cognitive Services OpenAI User a UAMI
        run: |
          az role assignment create \
            --assignee-object-id "${{ steps.deploy.outputs.uami_principal_id }}" \
            --assignee-principal-type ServicePrincipal \
            --role "Cognitive Services OpenAI User" \
            --scope "${{ vars.OPENAI_RESOURCE_ID }}" \
            --output none 2>/dev/null || echo "â„¹ï¸ Cognitive Services OpenAI User ya asignado"

          echo "âœ… Cognitive Services OpenAI User asignado a UAMI"

      # â”€â”€ 9. Health check (espera cold start de Container Apps) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Health check backend
        run: |
          echo "â³ Esperando arranque del backendâ€¦"
          for i in $(seq 1 20); do
            STATUS=$(curl -m 10 -s -o /dev/null -w "%{http_code}" \
              "${{ steps.deploy.outputs.backend_url }}/health" 2>/dev/null || echo "000")
            echo "  [$i/20] $(date +%H:%M:%S) HTTP $STATUS"
            if [[ "$STATUS" == "200" ]]; then
              echo "âœ… Backend online"
              exit 0
            fi
            sleep 15
          done
          echo "âŒ Timeout: backend no respondiÃ³ en ~5 min"
          exit 1

      # â”€â”€ 9. Resumen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Resumen deploy
        if: always()
        run: |
          ENV="${{ github.event.inputs.environment || 'prod' }}"
          echo "## ðŸš€ Deploy Lanyards AI Generator" >> $GITHUB_STEP_SUMMARY
          echo "| Campo | Valor |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Entorno        | \`${ENV}\` |"                                           >> $GITHUB_STEP_SUMMARY
          echo "| Resource Group | \`${{ vars.AZURE_RG }}\` |"                            >> $GITHUB_STEP_SUMMARY
          echo "| Key Vault      | \`${{ steps.deploy.outputs.kv_name }}\` |"            >> $GITHUB_STEP_SUMMARY
          echo "| Frontend       | ${{ steps.deploy.outputs.frontend_url }} |"           >> $GITHUB_STEP_SUMMARY
          echo "| Backend App    | \`${{ env.BACKEND_APP }}\` |"                          >> $GITHUB_STEP_SUMMARY
          echo "| Frontend App   | \`${{ env.FRONTEND_APP }}\` |"                         >> $GITHUB_STEP_SUMMARY
          echo "| Commit         | \`${{ github.sha }}\` |"                               >> $GITHUB_STEP_SUMMARY
          echo "| Autor          | ${{ github.actor }} |"                                 >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” Secretos y autenticaciÃ³n" >> $GITHUB_STEP_SUMMARY
          echo "| Servicio | Mecanismo |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-----------|" >> $GITHUB_STEP_SUMMARY
          echo "| Azure OpenAI   | Keyless â€” UAMI con \`Cognitive Services OpenAI User\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Azure Storage  | Keyless â€” UAMI con \`Storage Blob Data Contributor\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ACR Pull       | Keyless â€” UAMI con \`AcrPull\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Chainlit Auth  | AKV \`lanyards-chainlit-auth-secret\` â† GitHub Secret |" >> $GITHUB_STEP_SUMMARY

