name: Deploy â€” QR Accreditation

# â”€â”€â”€ DescripciÃ³n â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Despliega la infraestructura (Bicep) y actualiza las Container Apps.
# Todos los secretos se leen del Azure Key Vault en tiempo de ejecuciÃ³n.
# GitHub solo almacena las credenciales OIDC (identidad, no secretos de negocio).
#
# â”€â”€â”€ Secretos en GitHub (solo OIDC â€” los mÃ­nimos imprescindibles) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#   AZURE_CLIENT_ID         â†’ App Registration para OIDC
#   AZURE_TENANT_ID         â†’ Tenant de la suscripciÃ³n Sponsorship
#   AZURE_SUBSCRIPTION_ID   â†’ ID de la suscripciÃ³n Sponsorship
#
# â”€â”€â”€ Variables de repositorio (Settings â†’ Variables, no Secrets) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#   AZURE_RG       â†’ Resource Group compartido, e.g. rg-azurebrains-sponsorship
#   KEY_VAULT_NAME â†’ Nombre del AKV, e.g. kv-azurebrains
#   ACR_NAME       â†’ Nombre corto del ACR, e.g. acrazurebrainschat
#
# â”€â”€â”€ Secretos que deben existir en el AKV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#   qrgen-acr-username         â†’ usuario del ACR (o token de acceso)
#   qrgen-acr-password         â†’ password/token del ACR
#   qrgen-openai-api-key       â†’ clave de Azure OpenAI
#   qrgen-chainlit-auth-secret â†’ secreto de autenticaciÃ³n Chainlit

on:
  workflow_run:
    workflows: ["Build & Push â€” QR Accreditation"]
    types: [completed]
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Entorno (afecta tags y rÃ©plicas)'
        required: false
        default: 'prod'
        type: choice
        options: [dev, prod]

permissions:
  id-token: write   # OIDC
  contents: read

env:
  BACKEND_APP:    acrazurebrainschat.azurecr.io/qrgen/backend-app:latest
  FRONTEND_APP:   acrazurebrainschat.azurecr.io/qrgen/frontend-app:latest
  AZURE_LOCATION: westeurope

jobs:
  deploy:
    name: Deploy ${{ github.event.inputs.environment || 'prod' }}
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event.workflow_run.conclusion == 'success'

    environment:
      name: ${{ github.event.inputs.environment || 'prod' }}

    steps:
      - uses: actions/checkout@v4

      # â”€â”€ 1. Login Azure (OIDC) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Login Azure (OIDC)
        uses: azure/login@v2
        with:
          client-id:       ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id:       ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # â”€â”€ 2. Leer todos los secretos del AKV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      #   El SP OIDC necesita el rol "Key Vault Secrets User" sobre el AKV.
      - name: Leer secretos del AKV
        id: kv
        run: |
          KV="${{ vars.KEY_VAULT_NAME }}"
          echo "ðŸ”‘ Leyendo secretos de: $KV"

          get_secret() {
            az keyvault secret show \
              --vault-name "$KV" \
              --name "$1" \
              --query value \
              --output tsv 2>/dev/null
          }

          ACR_USR=$(get_secret "qrgen-acr-username")
          ACR_PWD=$(get_secret "qrgen-acr-password")
          OAI_KEY=$(get_secret "qrgen-openai-api-key")
          CL_SEC=$(get_secret  "qrgen-chainlit-auth-secret")

          # Enmascarar valores en los logs de GitHub Actions
          echo "::add-mask::$ACR_USR"
          echo "::add-mask::$ACR_PWD"
          echo "::add-mask::$OAI_KEY"
          echo "::add-mask::$CL_SEC"

          echo "acr_username=$ACR_USR"          >> $GITHUB_OUTPUT
          echo "acr_password=$ACR_PWD"          >> $GITHUB_OUTPUT
          echo "openai_api_key=$OAI_KEY"        >> $GITHUB_OUTPUT
          echo "chainlit_auth_secret=$CL_SEC"   >> $GITHUB_OUTPUT
          echo "âœ… Secretos cargados desde AKV"

      # â”€â”€ 3. Crear Resource Group si no existe â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Crear Resource Group
        run: |
          ENV="${{ github.event.inputs.environment || 'prod' }}"
          az group create \
            --name     "${{ vars.AZURE_RG }}" \
            --location "${{ env.AZURE_LOCATION }}" \
            --tags     Environment="$ENV" Project=qr-accreditation ManagedBy=Bicep-IaC \
            --output none
          echo "âœ… Resource Group: ${{ vars.AZURE_RG }}"

      # â”€â”€ 4. Instalar Bicep CLI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Instalar Bicep
        run: az bicep install

      # â”€â”€ 5. Validar Bicep (what-if) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Validar Bicep (what-if)
        run: |
          ENV="${{ github.event.inputs.environment || 'prod' }}"
          az deployment group what-if \
            --resource-group "${{ vars.AZURE_RG }}" \
            --template-file  bicep/main.bicep \
            --parameters     bicep/parameters/${ENV}.bicepparam \
            --parameters \
              acrUsername="${{ steps.kv.outputs.acr_username }}" \
              acrPassword="${{ steps.kv.outputs.acr_password }}" \
              openAiApiKey="${{ steps.kv.outputs.openai_api_key }}" \
              chainlitAuthSecret="${{ steps.kv.outputs.chainlit_auth_secret }}" \
              backendImage="${{ env.BACKEND_APP }}" \
              frontendImage="${{ env.FRONTEND_APP }}"

      # â”€â”€ 6. Desplegar infraestructura â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Deploy Bicep
        id: deploy
        run: |
          ENV="${{ github.event.inputs.environment || 'prod' }}"
          OUTPUT=$(az deployment group create \
            --resource-group "${{ vars.AZURE_RG }}" \
            --template-file  bicep/main.bicep \
            --parameters     bicep/parameters/${ENV}.bicepparam \
            --parameters \
              acrUsername="${{ steps.kv.outputs.acr_username }}" \
              acrPassword="${{ steps.kv.outputs.acr_password }}" \
              openAiApiKey="${{ steps.kv.outputs.openai_api_key }}" \
              chainlitAuthSecret="${{ steps.kv.outputs.chainlit_auth_secret }}" \
              backendImage="${{ env.BACKEND_APP }}" \
              frontendImage="${{ env.FRONTEND_APP }}" \
            --query "properties.outputs" \
            --output json)

          FRONTEND_URL=$(echo "$OUTPUT" | jq -r '.frontendUrl.value')
          BACKEND_URL=$(echo "$OUTPUT"  | jq -r '.backendUrl.value')
          echo "frontend_url=$FRONTEND_URL" >> $GITHUB_OUTPUT
          echo "backend_url=$BACKEND_URL"   >> $GITHUB_OUTPUT
          echo "âœ… Frontend: $FRONTEND_URL"
          echo "âœ… Backend:  $BACKEND_URL"

      # â”€â”€ 7. Health check (espera cold start de Container Apps) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Health check backend
        run: |
          echo "â³ Esperando arranque del backendâ€¦"
          for i in $(seq 1 20); do
            STATUS=$(curl -m 10 -s -o /dev/null -w "%{http_code}" \
              "${{ steps.deploy.outputs.backend_url }}/health" 2>/dev/null || echo "000")
            echo "  [$i/20] $(date +%H:%M:%S) HTTP $STATUS"
            if [[ "$STATUS" == "200" ]]; then
              echo "âœ… Backend online"
              exit 0
            fi
            sleep 15
          done
          echo "âŒ Timeout: backend no respondiÃ³ en ~5 min"
          exit 1

      # â”€â”€ 8. Resumen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Resumen deploy
        if: always()
        run: |
          ENV="${{ github.event.inputs.environment || 'prod' }}"
          echo "## ðŸš€ Deploy QR Accreditation" >> $GITHUB_STEP_SUMMARY
          echo "| Campo | Valor |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Entorno        | \`${ENV}\` |"                                              >> $GITHUB_STEP_SUMMARY
          echo "| Resource Group | \`${{ vars.AZURE_RG }}\` |"                               >> $GITHUB_STEP_SUMMARY
          echo "| Key Vault      | \`${{ vars.KEY_VAULT_NAME }}\` |"                         >> $GITHUB_STEP_SUMMARY
          echo "| Frontend       | ${{ steps.deploy.outputs.frontend_url }} |"              >> $GITHUB_STEP_SUMMARY
          echo "| Backend App    | \`${{ env.BACKEND_APP }}\` |"                             >> $GITHUB_STEP_SUMMARY
          echo "| Frontend App   | \`${{ env.FRONTEND_APP }}\` |"                            >> $GITHUB_STEP_SUMMARY
          echo "| Commit         | \`${{ github.sha }}\` |"                                  >> $GITHUB_STEP_SUMMARY
          echo "| Autor          | ${{ github.actor }} |"                                    >> $GITHUB_STEP_SUMMARY
