name: Deploy â€” Lanyards AI Generator

# â”€â”€â”€ Flujo de secretos â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#
#  GitHub Secrets necesarios (solo OIDC â€” ningÃºn secreto de negocio):
#    AZURE_CLIENT_ID         â†’ App Registration OIDC (identidad del pipeline)
#    AZURE_TENANT_ID         â†’ Tenant de la suscripciÃ³n
#    AZURE_SUBSCRIPTION_ID   â†’ ID de la suscripciÃ³n
#
#  GitHub Variables (Settings â†’ Variables):
#    AZURE_RG   â†’ Resource Group, p.ej. rg-lanyards-aigen
#    ACR_NAME   â†’ Nombre corto del ACR, p.ej. acrazurebrainschat
#
#  Azure Key Vault (authoritative runtime store â€” poblado por setup-keyvault.sh):
#    lanyards-openai-endpoint          â† endpoint Azure OpenAI
#    lanyards-openai-api-key           â† API key Azure OpenAI
#    lanyards-openai-deployment        â† nombre del deployment
#    lanyards-openai-api-version       â† versiÃ³n API
#    lanyards-chainlit-auth-secret     â† secreto Chainlit
#
#  Las Container Apps leen AKV directamente vÃ­a UAMI en runtime.
#  El pipeline NUNCA gestiona secretos de negocio: solo OIDC.
#
# â”€â”€â”€ Prerequisito (una sola vez) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  1. Ejecutar scripts/setup-keyvault.sh para poblar los secretos en AKV.
#  2. Ejecutar scripts/setup-github-secrets.sh para:
#     a. Crear el App Registration con credenciales OIDC federadas
#     b. Asignar los roles necesarios (Contributor, AcrPush, AcrPull sobre UAMI)
#     c. Subir AZURE_CLIENT_ID, AZURE_TENANT_ID, AZURE_SUBSCRIPTION_ID, AZURE_RG, ACR_NAME a GitHub

on:
  workflow_run:
    workflows: ["Build & Push â€” Lanyards AI Generator"]
    types: [completed]
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Entorno de despliegue'
        required: false
        default: 'prod'
        type: choice
        options: [dev, prod]

permissions:
  id-token: write   # OIDC â€” necesario para az login
  contents: read

env:
  BACKEND_APP:    acrazurebrainschat.azurecr.io/lanyards/backend-app:latest
  FRONTEND_APP:   acrazurebrainschat.azurecr.io/lanyards/frontend-app:latest
  AZURE_LOCATION: westeurope
  PROJECT_NAME:   lanyards-aigen

jobs:
  deploy:
    name: Deploy ${{ github.event.inputs.environment || 'prod' }}
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event.workflow_run.conclusion == 'success'

    environment:
      name: ${{ github.event.inputs.environment || 'prod' }}

    steps:
      - uses: actions/checkout@v4

      # â”€â”€ 1. Login Azure (OIDC â€” sin credenciales en GitHub) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Login Azure (OIDC)
        uses: azure/login@v2
        with:
          client-id:       ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id:       ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # â”€â”€ 2. Crear Resource Group si no existe â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Crear Resource Group
        run: |
          ENV="${{ github.event.inputs.environment || 'prod' }}"
          # Si el RG ya existe, respetar su ubicaciÃ³n (evita InvalidResourceGroupLocation)
          RG_LOCATION=$(az group show --name "${{ vars.AZURE_RG }}" --query location -o tsv 2>/dev/null || echo "${{ env.AZURE_LOCATION }}")
          az group create \
            --name     "${{ vars.AZURE_RG }}" \
            --location "$RG_LOCATION" \
            --tags     Environment="$ENV" Project=lanyards-ai-generator ManagedBy=Bicep-IaC \
            --output none
          echo "âœ… Resource Group: ${{ vars.AZURE_RG }} (location: $RG_LOCATION)"

      # â”€â”€ 3. Crear AKV e inyectar secretos (idempotente) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      #   El AKV se crea tambiÃ©n vÃ­a Bicep (idempotente), pero necesitamos
      #   que los secretos existan ANTES de que Bicep despliegue las Container
      #   Apps (que los referencian vÃ­a keyVaultUrl).
      - name: Provisionar AKV y sincronizar secretos
        run: |
          # Nombre del KV = igual que calcula Bicep (kvNameOverride): kv-<projectName>
          # sin sufijo de entorno, para reconciliar el recurso ya existente.
          KV_NAME="kv-${{ env.PROJECT_NAME }}"
          KV_NAME="${KV_NAME:0:24}"
          echo "kv_name=$KV_NAME" >> $GITHUB_ENV

          # Crear AKV si no existe (RBAC mode â€” sin access policies)
          EXISTING=$(az keyvault show --name "$KV_NAME" --query name -o tsv 2>/dev/null || echo "")
          if [ -z "$EXISTING" ]; then
            echo "ðŸ”‘ Creando Key Vault: $KV_NAME"
            az keyvault create \
              --name              "$KV_NAME" \
              --resource-group    "${{ vars.AZURE_RG }}" \
              --location          "${{ env.AZURE_LOCATION }}" \
              --enable-rbac-authorization true \
              --retention-days    7 \
              --output none
            echo "âœ… Key Vault creado"
          else
            echo "âœ… Key Vault ya existe: $KV_NAME"
          fi

          # Asignar Key Vault Secrets Officer al SP del pipeline (para poder leer/escribir secretos)
          SP_OID=$(az rest --method GET \
            --url "https://graph.microsoft.com/v1.0/servicePrincipals?\$filter=appId eq '${{ secrets.AZURE_CLIENT_ID }}'" \
            --query "value[0].id" -o tsv)

          KV_ID=$(az keyvault show --name "$KV_NAME" --query id -o tsv)
          az role assignment create \
            --assignee-object-id "$SP_OID" \
            --assignee-principal-type ServicePrincipal \
            --role "Key Vault Secrets Officer" \
            --scope "$KV_ID" \
            --output none 2>/dev/null || echo "â„¹ï¸ Rol ya asignado"

          echo "âœ… AKV listo: $KV_NAME"

      # â”€â”€ 4. Instalar Bicep CLI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Instalar Bicep
        run: az bicep install

      # â”€â”€ 4b. Pre-aprovisionar UAMI y asignar AcrPull â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      #   Los Container Apps necesitan AcrPull durante su creaciÃ³n (Bicep step 6).
      #   Como el ACR es externo al RG, el rol debe existir ANTES del deploy.
      #   Bicep no falla si la UAMI ya existe (idempotente).
      - name: Pre-crear UAMI y asignar AcrPull
        run: |
          ENV="${{ github.event.inputs.environment || 'prod' }}"
          UAMI_NAME="id-${{ env.PROJECT_NAME }}-${ENV}"

          # Crear UAMI si no existe (Bicep la crearÃ¡ idempotente tambiÃ©n)
          az identity create \
            --name           "$UAMI_NAME" \
            --resource-group "${{ vars.AZURE_RG }}" \
            --location       "${{ env.AZURE_LOCATION }}" \
            --output none 2>/dev/null || true

          # Esperar propagaciÃ³n AAD (principal ID puede tardar unos segundos)
          for i in $(seq 1 10); do
            UAMI_PID=$(az identity show --name "$UAMI_NAME" \
              --resource-group "${{ vars.AZURE_RG }}" \
              --query principalId -o tsv 2>/dev/null || echo "")
            [[ -n "$UAMI_PID" ]] && break
            echo "  Esperando principalId UAMI... ($i/10)"
            sleep 6
          done
          echo "UAMI_PID=$UAMI_PID" >> $GITHUB_ENV

          # Asignar AcrPull (idempotente â€” no falla si ya existe)
          ACR_ID=$(az acr show --name "${{ vars.ACR_NAME }}" --query id -o tsv)
          az role assignment create \
            --assignee-object-id    "$UAMI_PID" \
            --assignee-principal-type ServicePrincipal \
            --role "AcrPull" \
            --scope "$ACR_ID" \
            --output none 2>/dev/null || echo "â„¹ï¸ AcrPull ya asignado"

          echo "âœ… UAMI: $UAMI_NAME | AcrPull: OK"

      # â”€â”€ 4c. Esperar propagaciÃ³n de roles en AAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      #   Los role assignments de Azure AD pueden tardar hasta 2-3 min en
      #   propagarse. Sin esta espera, el Container App falla al hacer pull
      #   aunque AcrPull estÃ© asignado.
      - name: Esperar propagaciÃ³n IAM (90s)
        run: |
          echo "â³ Esperando 90s para propagaciÃ³n de roles Azure IAM..."
          sleep 90
          echo "âœ… PropagaciÃ³n completada"

      # â”€â”€ 5. What-if (solo informativo) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Validar Bicep (what-if)
        continue-on-error: true   # informativo â€” no bloquea el deploy
        run: |
          ENV="${{ github.event.inputs.environment || 'prod' }}"
          az deployment group what-if \
            --resource-group "${{ vars.AZURE_RG }}" \
            --template-file  bicep/main.bicep \
            --parameters     bicep/parameters/${ENV}.bicepparam \
            --parameters \
              backendImage="${{ env.BACKEND_APP }}" \
              frontendImage="${{ env.FRONTEND_APP }}"

      # â”€â”€ 6. Desplegar infraestructura completa â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      #   main.bicep crea: UAMI, KV (idempotente), Storage, Container Apps.
      #   Los roles AcrPull y Storage Blob Data Contributor se asignan aquÃ­.
      - name: Deploy Bicep
        id: deploy
        run: |
          ENV="${{ github.event.inputs.environment || 'prod' }}"
          OUTPUT=$(az deployment group create \
            --resource-group "${{ vars.AZURE_RG }}" \
            --template-file  bicep/main.bicep \
            --parameters     bicep/parameters/${ENV}.bicepparam \
            --parameters \
              backendImage="${{ env.BACKEND_APP }}" \
              frontendImage="${{ env.FRONTEND_APP }}" \
            --query "properties.outputs" \
            --output json)

          FRONTEND_URL=$(echo "$OUTPUT" | jq -r '.frontendUrl.value')
          BACKEND_URL=$(echo "$OUTPUT"  | jq -r '.backendUrl.value')
          KV_NAME_OUT=$(echo "$OUTPUT"  | jq -r '.keyVaultName.value')
          UAMI_PID=$(echo "$OUTPUT"     | jq -r '.uamiPrincipalId.value')

          echo "frontend_url=$FRONTEND_URL" >> $GITHUB_OUTPUT
          echo "backend_url=$BACKEND_URL"   >> $GITHUB_OUTPUT
          echo "kv_name=$KV_NAME_OUT"       >> $GITHUB_OUTPUT
          echo "uami_principal_id=$UAMI_PID" >> $GITHUB_OUTPUT
          echo "âœ… Frontend: $FRONTEND_URL"
          echo "âœ… Backend:  $BACKEND_URL"
          echo "âœ… Key Vault: $KV_NAME_OUT"

      # â”€â”€ 7. Asignar AcrPull a la UAMI (idempotente) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      #   La UAMI necesita AcrPull para poder hacer pull de imÃ¡genes desde ACR.
      #   El ACR es un recurso externo (distinto RG), por eso se asigna aquÃ­.
      - name: Asignar AcrPull a UAMI
        run: |
          ACR_ID=$(az acr show \
            --name "${{ vars.ACR_NAME }}" \
            --query id -o tsv)

          az role assignment create \
            --assignee-object-id "${{ steps.deploy.outputs.uami_principal_id }}" \
            --assignee-principal-type ServicePrincipal \
            --role "AcrPull" \
            --scope "$ACR_ID" \
            --output none 2>/dev/null || echo "â„¹ï¸ AcrPull ya asignado"

          echo "âœ… AcrPull asignado a UAMI sobre ACR"

      # â”€â”€ 8. Cognitive Services OpenAI User â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      #   El rol se asigna dentro de bicep/modules/openai.bicep en el step 4.
      #   No se necesita ninguna acciÃ³n adicional aquÃ­.

      # â”€â”€ 9. Health check (espera cold start de Container Apps) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      #   El backend tiene ingress INTERNO (external: false) â€” no es accesible
      #   desde internet. Se comprueba el estado via Azure CLI en lugar de curl.
      - name: Health check backend
        run: |
          ENV="${{ github.event.inputs.environment || 'prod' }}"
          CA_BACKEND="ca-${{ env.PROJECT_NAME }}-${ENV}-backend"
          RG="${{ vars.AZURE_RG }}"

          echo "â³ Esperando arranque del backend '${CA_BACKEND}'â€¦"
          for i in $(seq 1 20); do
            STATUS=$(az containerapp show \
              --name "$CA_BACKEND" \
              --resource-group "$RG" \
              --query "properties.runningStatus" -o tsv 2>/dev/null || echo "unknown")
            echo "  [$i/20] $(date +%H:%M:%S) runningStatus: $STATUS"
            if [[ "$STATUS" == "Running" ]]; then
              echo "âœ… Backend online (runningStatus=Running)"
              exit 0
            fi
            sleep 15
          done
          echo "âš ï¸  Backend no alcanzÃ³ estado 'Running' en ~5 min (Ãºltimo: $STATUS)"
          echo "   La infraestructura se desplegÃ³ correctamente. Verifica los logs del Container App."
          exit 0

      # â”€â”€ 9. Resumen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Resumen deploy
        if: always()
        run: |
          ENV="${{ github.event.inputs.environment || 'prod' }}"
          echo "## ðŸš€ Deploy Lanyards AI Generator" >> $GITHUB_STEP_SUMMARY
          echo "| Campo | Valor |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Entorno        | \`${ENV}\` |"                                           >> $GITHUB_STEP_SUMMARY
          echo "| Resource Group | \`${{ vars.AZURE_RG }}\` |"                            >> $GITHUB_STEP_SUMMARY
          echo "| Key Vault      | \`${{ steps.deploy.outputs.kv_name }}\` |"            >> $GITHUB_STEP_SUMMARY
          echo "| Frontend       | ${{ steps.deploy.outputs.frontend_url }} |"           >> $GITHUB_STEP_SUMMARY
          echo "| Backend App    | \`${{ env.BACKEND_APP }}\` |"                          >> $GITHUB_STEP_SUMMARY
          echo "| Frontend App   | \`${{ env.FRONTEND_APP }}\` |"                         >> $GITHUB_STEP_SUMMARY
          echo "| Commit         | \`${{ github.sha }}\` |"                               >> $GITHUB_STEP_SUMMARY
          echo "| Autor          | ${{ github.actor }} |"                                 >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” Secretos y autenticaciÃ³n" >> $GITHUB_STEP_SUMMARY
          echo "| Servicio | Mecanismo |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-----------|" >> $GITHUB_STEP_SUMMARY
          echo "| Azure OpenAI   | Keyless â€” UAMI con \`Cognitive Services OpenAI User\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Azure Storage  | Keyless â€” UAMI con \`Storage Blob Data Contributor\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ACR Pull       | Keyless â€” UAMI con \`AcrPull\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Chainlit Auth  | AKV \`lanyards-chainlit-auth-secret\` â† GitHub Secret |" >> $GITHUB_STEP_SUMMARY

