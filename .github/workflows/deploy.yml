name: Deploy â€” QR Accreditation

# â”€â”€â”€ DescripciÃ³n â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Despliega la infraestructura (Bicep) y actualiza las Container Apps
# con las imÃ¡genes reciÃ©n publicadas en ACR.
#
# Se ejecuta automÃ¡ticamente tras un build exitoso en main,
# o manualmente para forzar un re-deploy.
#
# â”€â”€â”€ Secretos necesarios en GitHub â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#   AZURE_CLIENT_ID, AZURE_TENANT_ID, AZURE_SUBSCRIPTION_ID  (OIDC)
#   ACR_USERNAME, ACR_PASSWORD
#   AZURE_OPENAI_API_KEY
#   CHAINLIT_AUTH_SECRET

on:
  workflow_run:
    workflows: ["Build & Push â€” QR Accreditation"]
    types: [completed]
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Entorno a desplegar'
        required: true
        default: 'dev'
        type: choice
        options: [dev, prod]

permissions:
  id-token: write   # OIDC
  contents: read

env:
  ACR:              acrazurebrainschat.azurecr.io
  BACKEND_APP:      acrazurebrainschat.azurecr.io/qrgen/backend-app:latest
  FRONTEND_APP:     acrazurebrainschat.azurecr.io/qrgen/frontend-app:latest
  AZURE_RG_DEV:     rg-qrgen-dev
  AZURE_RG_PROD:    rg-qrgen-prod
  AZURE_LOCATION:   westeurope

jobs:
  deploy:
    name: Deploy ${{ github.event.inputs.environment || 'dev' }}
    runs-on: ubuntu-latest
    # Solo ejecutar si el workflow de build terminÃ³ correctamente (o si es manual)
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event.workflow_run.conclusion == 'success'

    environment:
      name: ${{ github.event.inputs.environment || 'dev' }}

    steps:
      - uses: actions/checkout@v4

      # â”€â”€ Login Azure (OIDC â€” sin secretos de client secret) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Login Azure (OIDC)
        uses: azure/login@v2
        with:
          client-id:       ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id:       ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # â”€â”€ Determinar entorno â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Configurar variables de entorno
        id: env
        run: |
          ENV="${{ github.event.inputs.environment || 'dev' }}"
          echo "env=$ENV" >> $GITHUB_OUTPUT
          if [[ "$ENV" == "prod" ]]; then
            echo "rg=${{ env.AZURE_RG_PROD }}" >> $GITHUB_OUTPUT
          else
            echo "rg=${{ env.AZURE_RG_DEV }}" >> $GITHUB_OUTPUT
          fi

      # â”€â”€ Crear Resource Group si no existe â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Crear Resource Group
        run: |
          az group create \
            --name     ${{ steps.env.outputs.rg }} \
            --location ${{ env.AZURE_LOCATION }} \
            --tags Environment=${{ steps.env.outputs.env }} Project=qr-accreditation ManagedBy=Bicep-IaC \
            --output none
          echo "âœ… Resource Group: ${{ steps.env.outputs.rg }}"

      # â”€â”€ Instalar Bicep CLI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Instalar Bicep
        run: az bicep install

      # â”€â”€ Validar Bicep (what-if) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Validar Bicep (what-if)
        run: |
          az deployment group what-if \
            --resource-group  ${{ steps.env.outputs.rg }} \
            --template-file   bicep/main.bicep \
            --parameters      bicep/parameters/${{ steps.env.outputs.env }}.bicepparam \
            --parameters      acrUsername='${{ secrets.ACR_USERNAME }}' \
                              acrPassword='${{ secrets.ACR_PASSWORD }}' \
                              openAiApiKey='${{ secrets.AZURE_OPENAI_API_KEY }}' \
                              chainlitAuthSecret='${{ secrets.CHAINLIT_AUTH_SECRET }}' \
                              backendImage='${{ env.BACKEND_APP }}' \
                              frontendImage='${{ env.FRONTEND_APP }}'

      # â”€â”€ Desplegar infraestructura â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Deploy Bicep
        id: deploy
        run: |
          OUTPUT=$(az deployment group create \
            --resource-group  ${{ steps.env.outputs.rg }} \
            --template-file   bicep/main.bicep \
            --parameters      bicep/parameters/${{ steps.env.outputs.env }}.bicepparam \
            --parameters      acrUsername='${{ secrets.ACR_USERNAME }}' \
                              acrPassword='${{ secrets.ACR_PASSWORD }}' \
                              openAiApiKey='${{ secrets.AZURE_OPENAI_API_KEY }}' \
                              chainlitAuthSecret='${{ secrets.CHAINLIT_AUTH_SECRET }}' \
                              backendImage='${{ env.BACKEND_APP }}' \
                              frontendImage='${{ env.FRONTEND_APP }}' \
            --query "properties.outputs" \
            --output json)

          FRONTEND_URL=$(echo "$OUTPUT" | jq -r '.frontendUrl.value')
          BACKEND_URL=$(echo "$OUTPUT" | jq -r '.backendUrl.value')
          echo "frontend_url=$FRONTEND_URL" >> $GITHUB_OUTPUT
          echo "backend_url=$BACKEND_URL"   >> $GITHUB_OUTPUT
          echo "âœ… Frontend: $FRONTEND_URL"
          echo "âœ… Backend:  $BACKEND_URL"

      # â”€â”€ Health check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Health check backend
        run: |
          echo "â³ Esperando arranque del backend (Container Apps escala desde 0)â€¦"
          for i in $(seq 1 20); do
            STATUS=$(curl -m 10 -s -o /dev/null -w "%{http_code}" \
              "${{ steps.deploy.outputs.backend_url }}/health" 2>/dev/null || echo "000")
            echo "  [$i/20] $(date +%H:%M:%S) HTTP $STATUS"
            if [[ "$STATUS" == "200" ]]; then
              echo "âœ… Backend online"
              exit 0
            fi
            sleep 15
          done
          echo "âŒ Timeout: backend no respondiÃ³ en ~5 min"
          exit 1

      # â”€â”€ Resumen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Resumen deploy
        if: always()
        run: |
          echo "## ðŸš€ Deploy QR Accreditation â€” ${{ steps.env.outputs.env }}" >> $GITHUB_STEP_SUMMARY
          echo "| Campo | Valor |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Entorno        | \`${{ steps.env.outputs.env }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Resource Group | \`${{ steps.env.outputs.rg }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend       | ${{ steps.deploy.outputs.frontend_url }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend App    | ${{ env.BACKEND_APP }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend App   | ${{ env.FRONTEND_APP }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit         | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Autor          | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
