name: Build & Push â€” QR Accreditation

# â”€â”€â”€ Estrategia de imÃ¡genes Docker (4 capas) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#
#  qrgen/backend-base:latest   Python 3.12 + deps pesadas.  Build ~4-5 min.
#  qrgen/backend-app:latest    FROM backend-base + cÃ³digo.  Build ~15 s.
#  qrgen/frontend-base:latest  FROM chatapp/base + httpx.   Build ~20 s.
#  qrgen/frontend-app:latest   FROM frontend-base + cÃ³digo. Build ~10 s.
#
# â”€â”€â”€ AutenticaciÃ³n â€” OIDC puro, sin credenciales en GitHub â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#   El Service Principal necesita el rol AcrPush sobre acrazurebrainschat.
#   Tras az login (OIDC) se ejecuta Â«az acr login --nameÂ» que obtiene
#   un token temporal de 3 horas â€” ninguna contraseÃ±a toca GitHub.
#
# â”€â”€â”€ Secretos necesarios en GitHub (solo OIDC) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#   AZURE_CLIENT_ID, AZURE_TENANT_ID, AZURE_SUBSCRIPTION_ID
#
# â”€â”€â”€ Variables de repositorio (Settings â†’ Variables) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#   ACR_NAME = acrazurebrainschat

on:
  push:
    branches: [main, feature/ai-accreditation-agent]
    paths:
      - 'backend/**'
      - 'frontend/**'
      - '.github/workflows/build-push.yml'
  workflow_dispatch:
    inputs:
      force_rebuild_bases:
        description: 'Forzar rebuild de ambas imÃ¡genes base'
        required: false
        default: 'false'
        type: choice
        options: ['false', 'true']

permissions:
  id-token: write   # OIDC â€” necesario para az login
  contents: read

env:
  ACR: acrazurebrainschat.azurecr.io
  ACR_NAME: ${{ vars.ACR_NAME || 'acrazurebrainschat' }}

  CHATAPP_BASE:    acrazurebrainschat.azurecr.io/chatapp/base:latest        # existente, no se toca
  BACKEND_BASE:    acrazurebrainschat.azurecr.io/qrgen/backend-base:latest
  BACKEND_APP:     acrazurebrainschat.azurecr.io/qrgen/backend-app:latest
  FRONTEND_BASE:   acrazurebrainschat.azurecr.io/qrgen/frontend-base:latest
  FRONTEND_APP:    acrazurebrainschat.azurecr.io/qrgen/frontend-app:latest

# â”€â”€â”€ Job 1: Detectar quÃ© hay que reconstruir â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
jobs:
  check:
    name: Detectar cambios
    runs-on: ubuntu-latest
    outputs:
      backend_base:  ${{ steps.detect.outputs.backend_base }}
      frontend_base: ${{ steps.detect.outputs.frontend_base }}
      backend_code:  ${{ steps.detect.outputs.backend_code }}
      frontend_code: ${{ steps.detect.outputs.frontend_code }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detectar cambios por ruta
        id: detect
        run: |
          FORCE="${{ github.event.inputs.force_rebuild_bases }}"

          # Primer commit o force
          if [[ "$FORCE" == "true" ]] || ! git rev-parse HEAD~1 >/dev/null 2>&1; then
            echo "backend_base=true"   >> $GITHUB_OUTPUT
            echo "frontend_base=true"  >> $GITHUB_OUTPUT
            echo "backend_code=true"   >> $GITHUB_OUTPUT
            echo "frontend_code=true"  >> $GITHUB_OUTPUT
            echo "ðŸ”¨ Rebuild total forzado"
            exit 0
          fi

          CHANGED=$(git diff --name-only HEAD~1 HEAD)

          # Backend base: requirements.txt o Dockerfile.base
          if echo "$CHANGED" | grep -qE "^backend/(requirements\.txt|Dockerfile\.base)$"; then
            echo "backend_base=true" >> $GITHUB_OUTPUT
            echo "ðŸ”¨ Backend base â†’ rebuild (deps cambiadas)"
          else
            echo "backend_base=false" >> $GITHUB_OUTPUT
            echo "â­ï¸  Backend base â†’ reutilizar de ACR"
          fi

          # Frontend base: solo Dockerfile.base (requirements contiene solo httpx,
          # si cambia httpx tambiÃ©n triggerea el base)
          if echo "$CHANGED" | grep -qE "^frontend/(Dockerfile\.base|requirements\.txt)$"; then
            echo "frontend_base=true" >> $GITHUB_OUTPUT
            echo "ðŸ”¨ Frontend base â†’ rebuild (httpx o Dockerfile.base cambiados)"
          else
            echo "frontend_base=false" >> $GITHUB_OUTPUT
            echo "â­ï¸  Frontend base â†’ reutilizar de ACR (chatapp/base ya cacheada)"
          fi

          # App code: cualquier cambio en backend/app o backend/Dockerfile
          if echo "$CHANGED" | grep -qE "^backend/(app/|Dockerfile$|fonts/)"; then
            echo "backend_code=true" >> $GITHUB_OUTPUT
          else
            echo "backend_code=false" >> $GITHUB_OUTPUT
          fi

          # App code: cualquier cambio en frontend
          if echo "$CHANGED" | grep -qE "^frontend/(app\.py|agent/|client/|\.chainlit/|Dockerfile$)"; then
            echo "frontend_code=true" >> $GITHUB_OUTPUT
          else
            echo "frontend_code=false" >> $GITHUB_OUTPUT
          fi

# â”€â”€â”€ Job 2: Build imagen base del backend â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-backend-base:
    name: Build backend-base
    runs-on: ubuntu-latest
    needs: check
    if: needs.check.outputs.backend_base == 'true'

    steps:
      - uses: actions/checkout@v4

      - name: Login Azure (OIDC)
        uses: azure/login@v2
        with:
          client-id:       ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id:       ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Login ACR (token OIDC â€” sin credenciales)
        run: az acr login --name ${{ env.ACR_NAME }}

      - uses: docker/setup-buildx-action@v3

      - name: Build y push backend-base
        uses: docker/build-push-action@v5
        with:
          context:    ./backend
          file:       ./backend/Dockerfile.base
          push:       true
          tags:       ${{ env.BACKEND_BASE }}
          cache-from: type=registry,ref=${{ env.BACKEND_BASE }}
          cache-to:   type=inline

# â”€â”€â”€ Job 3: Build imagen base del frontend â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-frontend-base:
    name: Build frontend-base
    runs-on: ubuntu-latest
    needs: check
    if: needs.check.outputs.frontend_base == 'true'

    steps:
      - uses: actions/checkout@v4

      - name: Login Azure (OIDC)
        uses: azure/login@v2
        with:
          client-id:       ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id:       ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Login ACR (token OIDC)
        run: az acr login --name ${{ env.ACR_NAME }}

      - uses: docker/setup-buildx-action@v3

      - name: Build y push frontend-base
        # FROM chatapp/base (ya en ACR) + pip install httpx â†’ ~20 segundos
        uses: docker/build-push-action@v5
        with:
          context:    ./frontend
          file:       ./frontend/Dockerfile.base
          push:       true
          tags:       ${{ env.FRONTEND_BASE }}
          cache-from: type=registry,ref=${{ env.FRONTEND_BASE }}
          cache-to:   type=inline

# â”€â”€â”€ Job 4: Build imagen app del backend â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-backend-app:
    name: Build backend-app
    runs-on: ubuntu-latest
    needs: [check, build-backend-base]
    if: |
      always() &&
      needs.check.result == 'success' &&
      (needs.check.outputs.backend_code == 'true' || needs.check.outputs.backend_base == 'true') &&
      (needs.build-backend-base.result == 'success' || needs.build-backend-base.result == 'skipped')

    steps:
      - uses: actions/checkout@v4

      - name: Login Azure (OIDC)
        uses: azure/login@v2
        with:
          client-id:       ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id:       ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Login ACR (token OIDC)
        run: az acr login --name ${{ env.ACR_NAME }}

      - uses: docker/setup-buildx-action@v3

      - name: Build y push backend-app
        uses: docker/build-push-action@v5
        with:
          context:    ./backend
          file:       ./backend/Dockerfile
          push:       true
          tags:       ${{ env.BACKEND_APP }}
          build-args: BASE_IMAGE=${{ env.BACKEND_BASE }}
          cache-from: type=registry,ref=${{ env.BACKEND_APP }}
          cache-to:   type=inline

# â”€â”€â”€ Job 5: Build imagen app del frontend â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-frontend-app:
    name: Build frontend-app
    runs-on: ubuntu-latest
    needs: [check, build-frontend-base]
    if: |
      always() &&
      needs.check.result == 'success' &&
      (needs.check.outputs.frontend_code == 'true' || needs.check.outputs.frontend_base == 'true') &&
      (needs.build-frontend-base.result == 'success' || needs.build-frontend-base.result == 'skipped')

    steps:
      - uses: actions/checkout@v4

      - name: Login Azure (OIDC)
        uses: azure/login@v2
        with:
          client-id:       ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id:       ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Login ACR (token OIDC)
        run: az acr login --name ${{ env.ACR_NAME }}

      - uses: docker/setup-buildx-action@v3

      - name: Build y push frontend-app
        uses: docker/build-push-action@v5
        with:
          context:    ./frontend
          file:       ./frontend/Dockerfile
          push:       true
          tags:       ${{ env.FRONTEND_APP }}
          build-args: BASE_IMAGE=${{ env.FRONTEND_BASE }}
          cache-from: type=registry,ref=${{ env.FRONTEND_APP }}
          cache-to:   type=inline

# â”€â”€â”€ Job 6: Resumen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  summary:
    name: Resumen
    runs-on: ubuntu-latest
    needs: [check, build-backend-base, build-frontend-base, build-backend-app, build-frontend-app]
    if: always()

    steps:
      - name: Escribir resumen
        run: |
          echo "## ðŸ³ Build QR Accreditation" >> $GITHUB_STEP_SUMMARY
          echo "| Imagen | Estado |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| backend-base  | ${{ needs.build-backend-base.result  == 'skipped' && 'â­ï¸ reutilizada' || needs.build-backend-base.result  }} |" >> $GITHUB_STEP_SUMMARY
          echo "| frontend-base | ${{ needs.build-frontend-base.result == 'skipped' && 'â­ï¸ reutilizada' || needs.build-frontend-base.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| backend-app   | ${{ needs.build-backend-app.result   == 'skipped' && 'â­ï¸ sin cambios' || needs.build-backend-app.result   }} |" >> $GITHUB_STEP_SUMMARY
          echo "| frontend-app  | ${{ needs.build-frontend-app.result  == 'skipped' && 'â­ï¸ sin cambios' || needs.build-frontend-app.result  }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Autor  | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
